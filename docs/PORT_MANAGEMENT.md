# ポート管理ガイド

## 概要

このプロジェクトでは、ローカル開発環境でのポート競合を避けるため、シンプルで保守しやすい方法でポートを管理します。

## 基本原則

1. **環境変数優先**: `VITE_PORT`環境変数が設定されていればそれを使用
2. **デフォルト値**: 環境変数がなければポート3000を使用
3. **Viteの自動フォールバック**: `strictPort: false`により、指定ポートが使用中なら次の空きポートを自動選択

## 使用方法

### 1. 通常の開発（デフォルトポート3000）

```bash
npm run dev
```

ポート3000が使用中の場合、Viteは自動的に3001, 3002...と空きポートを探します。

### 2. カスタムポートで開発

```bash
# 環境変数で指定
VITE_PORT=5173 npm run dev

# E2Eテストも同じポートで実行
VITE_PORT=5173 npm run test:e2e
```

### 3. 自動的に空きポートを検出

```bash
# 開発サーバー
npm run dev:auto-port

# E2Eテスト
npm run test:e2e:auto
```

## トラブルシューティング

### ポート3000が他のアプリケーションで使用されている場合

**問題**: E2Eテスト実行時に以下のエラーが発生する
```
Error: Timed out waiting 120000ms from config.webServer.
```

**原因**: PlaywrightとViteの設定でポートが一致していない
- Viteは`strictPort: false`で自動的に次のポートを使用
- Playwrightは指定されたポートのみを待機

**解決方法**:

1. **推奨**: 環境変数でポートを明示的に指定
   ```bash
   VITE_PORT=5173 npm run test:e2e
   ```

2. **簡単**: 自動ポート検出スクリプトを使用
   ```bash
   npm run test:e2e:auto
   ```

3. **確認**: 現在使用されているポートを確認
   ```bash
   lsof -i :3000  # macOS/Linux
   netstat -ano | findstr :3000  # Windows
   ```

## CI/CD環境での注意事項

- CI環境では常にデフォルトポート（3000）を使用
- CIでポート競合が発生する場合は、環境変数で別ポートを指定

## 技術的な詳細

### なぜこの方法がベストプラクティスか

1. **シンプル**: 環境変数による制御は最も単純で理解しやすい
2. **柔軟性**: 開発者が自由にポートを選択できる
3. **互換性**: CI/CD環境でも同じ方法で動作
4. **保守性**: 特殊なスクリプトや複雑な設定が不要
5. **標準的**: 多くのNode.jsプロジェクトで採用されている方法