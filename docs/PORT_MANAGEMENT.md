# ポート管理ガイド

## 概要

このプロジェクトでは、ローカル開発環境でのポート競合を避けるため、シンプルで保守しやすい方法でポートを管理します。

## 基本原則

1. **環境変数優先**: `VITE_PORT`環境変数が設定されていればそれを使用
2. **デフォルト値**: 環境変数がなければポート3000を使用
3. **Viteの自動フォールバック**: `strictPort: false`により、指定ポートが使用中なら次の空きポートを自動選択

## 使用方法

### 1. 通常の開発（デフォルトポート3000）

```bash
npm run dev
```

ポート3000が使用中の場合、Viteは自動的に3001, 3002...と空きポートを探します。

### 2. カスタムポートで開発

```bash
# 環境変数で指定
VITE_PORT=5173 npm run dev
```

### 3. 自動的に空きポートを検出

```bash
# 開発サーバー
npm run dev:auto-port
```

## E2Eテスト

E2Eテストは開発サーバーとは独立した環境で実行されます：

### 1. 本番ビルドでのE2Eテスト（推奨）

```bash
# デフォルトポート4173でテスト専用サーバーを起動
npm run test:e2e

# カスタムポートを使用
VITE_TEST_PORT=5000 npm run test:e2e
```

- 本番環境に近い状態でテスト
- 開発サーバーとは別のポート（4173）を使用
- ビルド済みの静的ファイルを提供

### 2. 開発モードでのE2Eテスト

```bash
# 開発サーバーを使用してテスト（デバッグ用）
npm run test:e2e:dev

# カスタムポートを使用
VITE_PORT=5173 npm run test:e2e:dev
```

## トラブルシューティング

### E2Eテストが失敗する場合

**ポート4173が使用中の場合**:
```bash
# 別のポートを指定
VITE_TEST_PORT=5000 npm run test:e2e
```

**ビルドが失敗する場合**:
```bash
# キャッシュをクリアして再実行
rm -rf dist-test
npm run test:e2e
```

**開発サーバーでテストしたい場合**:
```bash
# 開発モードでE2Eテストを実行
npm run test:e2e:dev
```

## CI/CD環境での注意事項

- E2Eテストはポート4173で実行（開発サーバーとは別）
- CIでポート競合が発生する場合は、`VITE_TEST_PORT`で別ポートを指定
- E2Eテストは本番ビルドを使用するため、開発環境と同一性が保証される

## 技術的な詳細

### E2Eテスト用サーバーを分離する理由

1. **環境の分離**: 開発サーバーとテストサーバーが干渉しない
2. **本番環境の再現**: ビルド済みファイルでテストすることで、本番環境に近い状態を再現
3. **ポートの分離**: 開発（3000）とテスト（4173）で異なるポートを使用
4. **再現性**: ビルド結果に基づくテストのため、結果が安定
5. **パフォーマンス**: HMRや開発用機能が無効で、テストが高速化

### ポート設定

| 用途 | ポート | 環境変数 | 設定ファイル |
|------|---------|---------------|------------------|
| 開発 | 3000 | VITE_PORT | vite.config.ts |
| E2Eテスト | 4173 | VITE_TEST_PORT | vite.config.test.ts |