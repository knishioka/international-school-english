#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$FILES" ]; then
  echo "No TypeScript/JavaScript files to check"
  exit 0
fi

echo "ğŸ” Running pre-commit checks..."

# ESLint
echo "ğŸ“‹ Running ESLint..."
npx eslint $FILES --fix
if [ $? -ne 0 ]; then
  echo "âŒ ESLint found errors. Please fix them before committing."
  exit 1
fi

# Prettier
echo "âœ¨ Running Prettier..."
npx prettier --write $FILES
if [ $? -ne 0 ]; then
  echo "âŒ Prettier formatting failed."
  exit 1
fi

# TypeScript
echo "ğŸ”· Running TypeScript checks..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript compilation failed."
  exit 1
fi

# Unit tests
echo "ğŸ§ª Running unit tests..."
npm run test:unit -- --passWithNoTests
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed."
  exit 1
fi

# Check for console.log in production code
echo "ğŸ” Checking for console.log statements..."
if grep -r "console\.\(log\|debug\)" $FILES --exclude-dir=__tests__ --exclude-dir=tests; then
  echo "âŒ Found console.log/debug statements in production code!"
  exit 1
fi

# Re-add files after formatting
git add $FILES

echo "âœ… All pre-commit checks passed!"